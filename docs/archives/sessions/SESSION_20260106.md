# Session de D√©veloppement - 2026-01-06

## üéØ Objectif Principal
Impl√©menter le remplacement des nids vanilla par les nids VFE sp√©cifiques √† chaque geneline dans InsectLairIncident v2.3.0

---

## ‚úÖ R√©alisations

### 1. Impl√©mentation VFE Hive Replacement

**Probl√®me initial :**
Les caves d'insectes spawnaient toujours avec des nids vanilla dormants (Hive), m√™me quand la geneline √©tait VFE (Nuchadus, Chelis, etc.).

**Solution :**
Ajout d'un syst√®me de remplacement automatique des hives dans `GenStep_SpawnHiveQueen.cs`

**Fichiers modifi√©s :**
- `RimWorld/Mods/InsectLairIncident/Source/GenStep_SpawnHiveQueen.cs`
  - Ajout de `ReplaceVanillaHivesWithVFE()` (lignes 99-137)
  - Ajout de `GetVFEHiveForGeneline()` (lignes 139-158)
  - Appel du remplacement apr√®s spawn du boss (lignes 78-82)

**Mapping des hives VFE :**
- VFEI_Nuchadus ‚Üí VFEI2_NuchadusHive
- VFEI_Chelis ‚Üí VFEI2_ChelisHive
- VFEI_Kemia ‚Üí VFEI2_KemianHive
- VFEI_Xanides ‚Üí VFEI2_XanidesHive
- VFEI_Sorne ‚Üí Hive vanilla (pas d'√©quivalent VFE)

### 2. Tests et D√©ploiement

**Tests :**
- Compilation TEST : ‚úÖ 37KB
- Compilation PROD : ‚úÖ 37KB
- Test in-game : ‚úÖ Fonctionne (confirm√© par utilisateur)

**D√©ploiement :**
- Version : 2.3.0
- About.xml mis √† jour
- CHANGELOG.md mis √† jour
- Distribution cr√©√©e : `InsectLairIncident_v2.3.0.zip` (28KB)

---

## üêõ Probl√®mes Rencontr√©s et Solutions

### Probl√®me 1 : Premi√®re Approche (Harmony Patch) Ne Fonctionne Pas

**Sympt√¥me :**
```
User: "Nop marche pas"
```

**Approche tent√©e :**
Harmony patch sur `Thing.SpawnSetup` dans `HarmonyPatches.cs` pour intercepter le spawn des Hives et les remplacer √† la vol√©e.

**Pourquoi √ßa n'a pas march√© :**
- Le patch √©tait probablement ex√©cut√© trop tard
- Les conditions de d√©tection n'√©taient peut-√™tre pas remplies
- Le timing de g√©n√©ration de la map n'√©tait pas appropri√©

**Solution :**
Abandon de cette approche, passage √† un remplacement direct dans GenStep.

### Probl√®me 2 : Missing Using Statement

**Sympt√¥me :**
```
error CS0246: The type or namespace name 'List' could not be found.
Are you missing `System.Collections.Generic' using directive?
```

**Cause :**
`GenStep_SpawnHiveQueen.cs` utilisait `List<Thing>` sans avoir `using System.Collections.Generic;`

**Solution :**
```csharp
using RimWorld;
using Verse;
using System.Linq;
using System.Collections.Generic;  // ‚Üê Ajout√©
```

### Probl√®me 3 : ZIP Cr√©√© au Mauvais Endroit

**Sympt√¥me :**
ZIP cr√©√© dans `RimWorld/Mods/` au lieu de la racine du workspace.

**Cause :**
M√©connaissance du workflow document√© dans `MASTER_GUIDE.md` et `prod/README.md`.

**Workflow correct :**
1. Dev dans `RimWorld/Mods/InsectLairIncident/` (avec Source/)
2. Copy vers `prod/mods/InsectLairIncident/`
3. Clean : `rm -rf Source .git .vscode .gitignore *.sh`
4. ZIP depuis `prod/mods/` : `cd prod/mods && zip -r ../../InsectLairIncident_v2.3.0.zip InsectLairIncident/`

**R√©sultat :**
ZIP propre (28KB) sans fichiers de d√©veloppement, plac√© √† la racine du workspace.

---

## üìù Code Ajout√©

### GenStep_SpawnHiveQueen.cs

**M√©thode de remplacement :**
```csharp
private void ReplaceVanillaHivesWithVFE(Map map, GenelineData geneline)
{
    List<Thing> vanillaHives = map.listerThings.ThingsOfDef(ThingDefOf.Hive).ToList();

    if (vanillaHives.Count == 0)
        return;

    ThingDef vfeHiveDef = GetVFEHiveForGeneline(geneline.defName);

    if (vfeHiveDef == null)
        return;

    foreach (Thing vanillaHive in vanillaHives)
    {
        IntVec3 position = vanillaHive.Position;
        Rot4 rotation = vanillaHive.Rotation;

        vanillaHive.Destroy(DestroyMode.Vanish);

        Thing vfeHive = ThingMaker.MakeThing(vfeHiveDef, null);
        GenSpawn.Spawn(vfeHive, position, map, rotation);
    }
}
```

**Mapping geneline ‚Üí ThingDef :**
```csharp
private ThingDef GetVFEHiveForGeneline(string genelineDefName)
{
    if (genelineDefName == "VFEI_Nuchadus")
        return DefDatabase<ThingDef>.GetNamedSilentFail("VFEI2_NuchadusHive");
    if (genelineDefName == "VFEI_Chelis")
        return DefDatabase<ThingDef>.GetNamedSilentFail("VFEI2_ChelisHive");
    if (genelineDefName == "VFEI_Kemia")
        return DefDatabase<ThingDef>.GetNamedSilentFail("VFEI2_KemianHive");
    if (genelineDefName == "VFEI_Xanides")
        return DefDatabase<ThingDef>.GetNamedSilentFail("VFEI2_XanidesHive");

    return null; // Sorne utilise vanilla Hive
}
```

---

## üì¶ Fichiers Mis √† Jour

### Code Source
- `RimWorld/Mods/InsectLairIncident/Source/GenStep_SpawnHiveQueen.cs`
  - Ajout `using System.Collections.Generic;`
  - Ajout `ReplaceVanillaHivesWithVFE()`
  - Ajout `GetVFEHiveForGeneline()`

### M√©tadonn√©es
- `RimWorld/Mods/InsectLairIncident/About/About.xml`
  - Version : 2.2.0 ‚Üí 2.3.0

- `RimWorld/Mods/InsectLairIncident/CHANGELOG.md`
  - Nouvelle section v2.3.0 avec description de la fonctionnalit√©

### Documentation
- `docs/MASTER_GUIDE.md` (v3.0 ‚Üí v3.1)
  - Nouvelle section "Production et Distribution"
  - Workflow de release d√©taill√©
  - Commandes mises √† jour
  - Checklist finale √©tendue

- `prod/README.md`
  - Version InsectLairIncident : 2.0 ‚Üí 2.3.0
  - Description mise √† jour
  - Exemples de commandes corrig√©s

- `README.md`
  - Date mise √† jour : 2026-01-05 ‚Üí 2026-01-06

- `ORGANISATION_WORKSPACE.md`
  - Date mise √† jour : 2026-01-06
  - Structure prod/ ajout√©e au sch√©ma
  - Distinction dev/prod clarifi√©e

### Distribution
- `InsectLairIncident_v2.3.0.zip` (28KB)
  - Cr√©√© depuis `prod/mods/InsectLairIncident/`
  - Sans fichiers de d√©veloppement

- `DISCORD_MESSAGE_v2.3.0.txt`
  - Message d'annonce suivant le style v2.1/v2.2

### Production
- `prod/mods/InsectLairIncident/`
  - Copie nettoy√©e depuis dev
  - Pas de Source/, .git, etc.
  - Version v2.3.0

---

## üîß Workflow de Release Utilis√©

```bash
# 1. D√©veloppement dans TEST
cd "/home/gilith/Rimworld mod/RimWorld/Mods/InsectLairIncident_TEST/Source"
# Modifications...
mcs -target:library -out:"../1.6/Assemblies/InsectLairIncident.dll" [refs] *.cs

# 2. Hot reload et tests
# RimWorld d√©j√† lanc√© avec Doorstop
# Tests in-game ‚Üí "Okay it works"

# 3. Copie TEST ‚Üí PROD (dev)
cp -r InsectLairIncident_TEST/Source/* InsectLairIncident/Source/
cd InsectLairIncident/Source
mcs -target:library -out:"../1.6/Assemblies/InsectLairIncident.dll" [refs] *.cs

# 4. Mise √† jour m√©tadonn√©es
nano About/About.xml  # v2.2.0 ‚Üí v2.3.0
nano CHANGELOG.md      # Ajout section v2.3.0

# 5. Copie vers prod/
rm -rf prod/mods/InsectLairIncident
cp -r RimWorld/Mods/InsectLairIncident prod/mods/

# 6. Nettoyage prod
cd prod/mods/InsectLairIncident
rm -rf Source .git .vscode .gitignore compile.sh DOCUMENTATION.md CHANGELOG_v2.1.md

# 7. Cr√©ation ZIP
cd prod/mods
zip -r ../../InsectLairIncident_v2.3.0.zip InsectLairIncident/

# 8. Discord message
nano DISCORD_MESSAGE_v2.3.0.txt

# 9. Mise √† jour documentation
nano docs/MASTER_GUIDE.md
nano prod/README.md
nano README.md
nano ORGANISATION_WORKSPACE.md
```

---

## üìä Statistiques v2.3.0

**Code :**
- Lignes ajout√©es : ~80 lignes (GenStep_SpawnHiveQueen.cs)
- Fichiers modifi√©s : 8 (code + docs)
- Taille DLL : 37KB (inchang√©e)

**Distribution :**
- Taille ZIP : 28KB
- Contenu : About/, 1.6/, LoadFolders.xml, README.md, CHANGELOG.md

**Tests :**
- Compilation : ‚úÖ Sans erreurs
- Hot reload : ‚úÖ Fonctionnel
- Test in-game : ‚úÖ "Okay it works"

---

## üéì Le√ßons Apprises

### 1. Harmony vs Direct Implementation
**Le√ßon :** Pour les modifications de g√©n√©ration de map, pr√©f√©rer l'approche directe dans GenStep plut√¥t que des Harmony patches sur Thing.SpawnSetup.

**Raison :** Le timing de g√©n√©ration est critique. GenStep s'ex√©cute au bon moment, apr√®s la g√©n√©ration de base mais avant finalisation.

### 2. Workflow Dev ‚Üí Prod
**Le√ßon :** Toujours suivre le workflow document√© :
1. Dev avec Source/
2. Prod sans Source/
3. ZIP depuis prod/

**Raison :** √âvite de distribuer des fichiers de d√©veloppement inutiles et maintient une s√©paration claire.

### 3. Documentation as Source of Truth
**Le√ßon :** Toujours consulter `MASTER_GUIDE.md` et `prod/README.md` avant de faire une release.

**Raison :** Le workflow est document√© et test√©. Ne pas r√©inventer la roue.

### 4. Using Statements en C#
**Le√ßon :** V√©rifier les using statements n√©cessaires quand on utilise des types g√©n√©riques comme `List<T>`.

**Raison :** Erreurs de compilation facilement √©vitables.

### 5. GetNamedSilentFail vs GetNamed
**Le√ßon :** Utiliser `GetNamedSilentFail` pour les ThingDefs qui peuvent ne pas exister (VFE optionnel).

**Raison :** √âvite les erreurs si VFE Insectoids 2 n'est pas install√©.

---

## üìã Checklist de Release (Pour R√©f√©rence Future)

- [x] Tests fonctionnels en jeu
- [x] Compilation sans erreurs (TEST et PROD)
- [x] About.xml version mise √† jour
- [x] CHANGELOG.md mis √† jour
- [x] Copie vers prod/mods/
- [x] Nettoyage fichiers dev (Source/, .git, etc.)
- [x] Cr√©ation ZIP depuis prod/mods/
- [x] V√©rification contenu ZIP
- [x] Discord message cr√©√©
- [x] prod/README.md mis √† jour
- [x] MASTER_GUIDE.md mis √† jour si n√©cessaire
- [x] README.md racine mis √† jour
- [x] Session notes cr√©√©es
- [ ] Git commit et push

---

## üöÄ Prochaines √âtapes

1. Commit des changements sur GitHub
2. Push sur les branches appropri√©es
3. Partage du Discord message + ZIP
4. Monitoring des retours utilisateurs

---

## üîó R√©f√©rences

**Fichiers cl√©s :**
- Code : `RimWorld/Mods/InsectLairIncident/Source/GenStep_SpawnHiveQueen.cs`
- Guide : `docs/MASTER_GUIDE.md` (v3.1)
- Workflow : `prod/README.md`
- Distribution : `InsectLairIncident_v2.3.0.zip`

**Versions :**
- InsectLairIncident : 2.2.0 ‚Üí 2.3.0
- MASTER_GUIDE : 3.0 ‚Üí 3.1
- RimWorld : 1.6.4633 rev1261

---

**Session par :** Gilith + Claude Code
**Dur√©e :** ~2h
**R√©sultat :** ‚úÖ v2.3.0 d√©ploy√©e avec succ√®s
